<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Cockpit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-white">Admin Cockpit</h1>
            <p class="text-gray-400">Manage and monitor masterclass enrollments.</p>
        </header>

        <!-- Instructions & Auth -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 md:col-span-1">
                <h2 class="font-bold text-lg mb-2 text-white">How to Use</h2>
                <ol class="list-decimal list-inside text-sm text-gray-300 space-y-1">
                    <li>Enter your Admin Token.</li>
                    <li>Click "Load Data" to fetch current stats and enrollments.</li>
                    <li>Use the buttons to manually adjust counters if necessary.</li>
                    <li>Export enrollment data as CSV.</li>
                </ol>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 md:col-span-2">
                <label for="admin-token" class="block mb-2 text-sm font-medium text-gray-300">Admin Token</label>
                <div class="flex gap-4">
                    <input type="password" id="admin-token" placeholder="Paste your secret token here" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-3">
                    <button id="load-data-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-6 py-3">Load Data</button>
                </div>
            </div>
        </div>
        
        <!-- Counters -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
             <div class="bg-gray-800 p-5 rounded-xl border border-gray-700">
                <h3 class="font-semibold text-white">Occasional Project Manager</h3>
                <p class="text-4xl font-extrabold text-green-400 my-2" id="count-OPM">0</p>
                <div class="flex gap-2">
                    <button data-mc="OPM" data-delta="-1" class="adj-btn flex-1 bg-red-600/80 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">-1</button>
                    <button data-mc="OPM" data-delta="1" class="adj-btn flex-1 bg-green-600/80 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">+1</button>
                </div>
             </div>
             <div class="bg-gray-800 p-5 rounded-xl border border-gray-700">
                <h3 class="font-semibold text-white">Agile PMO Transformation</h3>
                <p class="text-4xl font-extrabold text-green-400 my-2" id="count-AGP">0</p>
                <div class="flex gap-2">
                    <button data-mc="AGP" data-delta="-1" class="adj-btn flex-1 bg-red-600/80 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">-1</button>
                    <button data-mc="AGP" data-delta="1" class="adj-btn flex-1 bg-green-600/80 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">+1</button>
                </div>
             </div>
             <div class="bg-gray-800 p-5 rounded-xl border border-gray-700">
                <h3 class="font-semibold text-white">Streets-Smart SAP PM</h3>
                <p class="text-4xl font-extrabold text-green-400 my-2" id="count-SAP">0</p>
                <div class="flex gap-2">
                    <button data-mc="SAP" data-delta="-1" class="adj-btn flex-1 bg-red-600/80 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">-1</button>
                    <button data-mc="SAP" data-delta="1" class="adj-btn flex-1 bg-green-600/80 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">+1</button>
                </div>
             </div>
        </div>

        <!-- Enrollment Table -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Enrollments</h2>
                <button id="export-csv-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-medium rounded-lg text-sm px-5 py-2.5">Export as CSV</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Timestamp</th>
                            <th scope="col" class="px-6 py-3">Course</th>
                            <th scope="col" class="px-6 py-3">Seat</th>
                            <th scope="col" class="px-6 py-3">Price</th>
                            <th scope="col" class="px-6 py-3">Name</th>
                            <th scope="col" class="px-6 py-3">Email</th>
                            <th scope="col" class="px-6 py-3">Company</th>
                        </tr>
                    </thead>
                    <tbody id="enrollment-table-body">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://st2s-enroll.a-hashem.workers.dev"; // Your worker URL
        const COURSE_DETAILS = {
            "OPM": "Occasional Project Manager Masterclass",
            "AGP": "Agile PMO Transformation Masterclass",
            "SAP": "Streets-Smart SAP Project Management"
        };
        let enrollmentsData = [];

        const tokenInput = document.getElementById('admin-token');
        const loadBtn = document.getElementById('load-data-btn');
        const tableBody = document.getElementById('enrollment-table-body');
        const exportBtn = document.getElementById('export-csv-btn');

        function getAuthHeaders() {
            const token = tokenInput.value.trim();
            if (!token) {
                alert('Admin token is required.');
                return null;
            }
            return { 'Authorization': `Bearer ${token}` };
        }

        async function loadCounters() {
            try {
                const response = await fetch(`${API_BASE}/api/counters`);
                if (!response.ok) throw new Error('Failed to fetch counts.');
                const data = await response.json();
                document.getElementById('count-OPM').textContent = data.counts.OPM || 0;
                document.getElementById('count-AGP').textContent = data.counts.AGP || 0;
                document.getElementById('count-SAP').textContent = data.counts.SAP || 0;
            } catch (error) {
                alert(`Error loading counters: ${error.message}`);
            }
        }
        
        async function loadEnrollees() {
            const headers = getAuthHeaders();
            if (!headers) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/enrollees`, { headers });
                if (response.status === 401) throw new Error('Unauthorized. Check your admin token.');
                if (!response.ok) throw new Error('Failed to fetch enrollees.');
                
                const data = await response.json();
                enrollmentsData = data.enrollments || [];
                tableBody.innerHTML = ''; // Clear existing rows
                
                enrollmentsData.forEach(e => {
                    const row = `
                        <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700/50">
                            <td class="px-6 py-4">${new Date(e.createdAt).toLocaleString()}</td>
                            <td class="px-6 py-4">${COURSE_DETAILS[e.courseId] || e.courseId}</td>
                            <td class="px-6 py-4">${e.seatNumber}</td>
                            <td class="px-6 py-4">â‚¬${e.priceAtLock}</td>
                            <td class="px-6 py-4">${e.fullName}</td>
                            <td class="px-6 py-4">${e.email}</td>
                            <td class="px-6 py-4">${e.company}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                alert(`Error loading enrollees: ${error.message}`);
            }
        }

        async function adjustCounter(mc, delta) {
            const headers = { ...getAuthHeaders(), 'Content-Type': 'application/json' };
            if (!headers['Authorization']) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/counter/adjust`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ courseId: mc, delta: delta })
                });
                if (response.status === 401) throw new Error('Unauthorized.');
                if (!response.ok) throw new Error('Failed to adjust counter.');
                await loadCounters(); // Refresh counts after adjustment
            } catch (error) {
                alert(`Error adjusting counter: ${error.message}`);
            }
        }
        
        function exportToCsv() {
            if (enrollmentsData.length === 0) {
                alert("No data to export.");
                return;
            }
            const headers = "Timestamp,Course,Seat,Price,Name,Email,Company,Role,Phone,Country\n";
            const rows = enrollmentsData.map(e => {
                const values = [
                    new Date(e.createdAt).toISOString(),
                    COURSE_DETAILS[e.courseId] || e.courseId,
                    e.seatNumber,
                    e.priceAtLock,
                    `"${e.fullName}"`,
                    e.email,
                    `"${e.company}"`,
                    `"${e.role}"`,
                    e.phone,
                    e.country
                ];
                return values.join(',');
            }).join('\n');

            const csvContent = "data:text/csv;charset=utf-8," + headers + rows;
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "enrollments.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        loadBtn.addEventListener('click', () => {
            loadCounters();
            loadEnrollees();
        });
        
        document.querySelectorAll('.adj-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const mc = e.target.dataset.mc;
                const delta = parseInt(e.target.dataset.delta, 10);
                adjustCounter(mc, delta);
            });
        });
        
        exportBtn.addEventListener('click', exportToCsv);

    </script>
</body>
</html>
