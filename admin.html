<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Cockpit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-10">
            <h1 class="text-3xl font-extrabold text-white">Admin Cockpit</h1>
            <p class="text-gray-400">Manage and monitor masterclass enrollments.</p>
        </header>

        <!-- How to Use & Token Input -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700">
                <h3 class="font-bold text-lg text-white mb-2">How to Use</h3>
                <ol class="list-decimal list-inside text-gray-300 space-y-1 text-sm">
                    <li>Enter your Admin Token.</li>
                    <li>Click "Load Data" to fetch current stats and enrollments.</li>
                    <li>Use the buttons to manually adjust counters if necessary.</li>
                    <li>Export enrollment data as CSV.</li>
                </ol>
            </div>
            <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700">
                <label for="admin-token" class="block mb-2 text-sm font-medium text-gray-300">Admin Token</label>
                <div class="flex gap-4">
                    <input type="password" id="admin-token" placeholder="Paste your token here" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                    <button id="load-data-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Load Data</button>
                </div>
            </div>
        </div>

        <!-- Counters -->
        <section id="counters-section" class="grid md:grid-cols-3 gap-6 mb-8">
            <!-- Dynamically loaded -->
        </section>

        <!-- Enrollments Table -->
        <section class="bg-gray-800/50 p-6 rounded-xl border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Enrollments</h2>
                <button id="export-csv-btn" class="text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5">Export as CSV</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700/50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Timestamp</th>
                            <th scope="col" class="px-6 py-3">Course</th>
                            <th scope="col" class="px-6 py-3">Seat</th>
                            <th scope="col" class="px-6 py-3">Price</th>
                            <th scope="col" class="px-6 py-3">Email</th>
                        </tr>
                    </thead>
                    <tbody id="enrollments-tbody">
                        <!-- Dynamically loaded -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Status Message -->
        <div id="status-message" class="mt-4 text-center text-sm min-h-[20px]"></div>
    </div>
    
    <script>
        const API_BASE = "https://st2s-enroll-worker.a-hashem.workers.dev";
        const COURSE_NAMES = {
            "OPM": "Occasional Project Manager",
            "AGP": "Agile PMO Transformation",
            "SAP": "Streets-Smart SAP PM"
        };
        
        const tokenInput = document.getElementById('admin-token');
        const loadBtn = document.getElementById('load-data-btn');
        const countersSection = document.getElementById('counters-section');
        const enrollmentsTbody = document.getElementById('enrollments-tbody');
        const exportBtn = document.getElementById('export-csv-btn');
        const statusMessageEl = document.getElementById('status-message');

        let enrolleesData = [];

        function setStatus(message, isError = false) {
            statusMessageEl.textContent = message;
            statusMessageEl.className = `mt-4 text-center text-sm min-h-[20px] ${isError ? 'text-red-400' : 'text-green-400'}`;
        }

        function getAuthHeaders() {
            const token = tokenInput.value.trim();
            if (!token) {
                setStatus('Admin token is required.', true);
                return null;
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        async function loadData() {
            setStatus('Loading data...');
            await fetchCounters();
            await fetchEnrollees();
            setStatus('Data loaded successfully.', false);
        }

        async function fetchCounters() {
            const headers = getAuthHeaders();
            if (!headers) return;

            try {
                const response = await fetch(`${API_BASE}/api/counters`);
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                renderCounters(data.counts);
            } catch (error) {
                console.error("Error fetching counters:", error);
                setStatus(`Error loading counters: ${error.message}`, true);
            }
        }

        function renderCounters(counts) {
            countersSection.innerHTML = '';
            for (const courseId in COURSE_NAMES) {
                const count = counts[courseId] || 0;
                const card = `
                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 text-center">
                        <h3 class="font-bold text-white mb-2">${COURSE_NAMES[courseId]}</h3>
                        <p class="text-5xl font-extrabold text-white mb-4">${count}</p>
                        <div class="flex justify-center gap-2">
                            <button data-course-id="${courseId}" data-delta="-1" class="adjust-btn w-12 h-12 text-white bg-red-600 hover:bg-red-700 font-bold rounded-lg text-xl">-1</button>
                            <button data-course-id="${courseId}" data-delta="1" class="adjust-btn w-12 h-12 text-white bg-green-600 hover:bg-green-700 font-bold rounded-lg text-xl">+1</button>
                        </div>
                    </div>
                `;
                countersSection.innerHTML += card;
            }
        }
        
        async function fetchEnrollees() {
            const headers = getAuthHeaders();
            if (!headers) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/enrollees`, { headers });
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                enrolleesData = data.enrollees;
                renderEnrollees(enrolleesData);
            } catch (error) {
                console.error("Error fetching enrollees:", error);
                setStatus(`Error loading enrollees: ${error.message}`, true);
            }
        }
        
        function renderEnrollees(enrollees) {
            enrollmentsTbody.innerHTML = '';
            if (enrollees.length === 0) {
                enrollmentsTbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">No enrollments yet.</td></tr>';
                return;
            }
            enrollees.forEach(e => {
                const row = `
                    <tr class="border-b border-gray-700">
                        <td class="px-6 py-4">${new Date(e.created_at).toLocaleString()}</td>
                        <td class="px-6 py-4">${COURSE_NAMES[e.course] || e.course}</td>
                        <td class="px-6 py-4">${e.seat}</td>
                        <td class="px-6 py-4">â‚¬${e.price / 100}</td>
                        <td class="px-6 py-4">${e.email}</td>
                    </tr>
                `;
                enrollmentsTbody.innerHTML += row;
            });
        }

        async function adjustCounter(event) {
            if (!event.target.classList.contains('adjust-btn')) return;

            const headers = getAuthHeaders();
            if (!headers) return;
            
            const courseId = event.target.dataset.courseId;
            const delta = parseInt(event.target.dataset.delta, 10);
            
            setStatus(`Adjusting ${courseId} counter...`);
            try {
                const response = await fetch(`${API_BASE}/api/admin/counter/adjust`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ courseId, delta })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                setStatus('Counter adjusted.', false);
                await fetchCounters();
            } catch (error) {
                 console.error("Error adjusting counter:", error);
                 setStatus(`Error adjusting counter: ${error.message}`, true);
            }
        }

        function exportToCsv() {
            if (enrolleesData.length === 0) {
                setStatus('No data to export.', true);
                return;
            }
            const headers = ["ID", "Course", "Seat", "Price_Euros", "Email", "Timestamp"];
            const rows = enrolleesData.map(e => [
                e.id,
                e.course,
                e.seat,
                e.price / 100,
                e.email,
                new Date(e.created_at).toISOString()
            ]);
            
            let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(",") + "\n" 
                + rows.map(r => r.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `enrollments_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        loadBtn.addEventListener('click', loadData);
        countersSection.addEventListener('click', adjustCounter);
        exportBtn.addEventListener('click', exportToCsv);
    </script>
</body>
</html>

